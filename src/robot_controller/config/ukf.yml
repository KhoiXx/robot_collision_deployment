# ==============================================================================
# UKF Localization Configuration
# Fusion: Wheel Odometry + IMU
# ==============================================================================

frequency: 22  # Tối ưu cho Jetson Nano
sensor_timeout: 0.3  # Tăng tolerance để tránh timeout với freq thấp hơn
two_d_mode: true
print_diagnostics: false  # TẮT để giảm CPU load
publish_acceleration: false  # Không cần publish acceleration

# Frame configuration
odom_frame: robot_0/odom
base_link_frame: dummy_base_link
world_frame: robot_0/odom
publish_tf: true  # BẬT để publish TF: odom → base_link

# ==============================================================================
# SENSOR 0: Wheel Odometry
# ==============================================================================
odom0: /robot_0/odom
odom0_config: [false, false, false,   # x, y, z position - KHÔNG DÙNG trực tiếp
               false, false, false,   # roll, pitch, yaw - KHÔNG DÙNG (dùng IMU)
               true,  true,  false,   # x_vel, y_vel, z_vel - CHỈ DÙNG VELOCITY
               false, false, false,   # roll_vel, pitch_vel, yaw_vel - KHÔNG DÙNG
               false, false, false]   # x_acc, y_acc, z_acc
odom0_queue_size: 5  # Giảm từ 10 để tiết kiệm memory
odom0_differential: true  # BẬT để tích phân velocity thay vì dùng position trực tiếp
odom0_relative: false

# Rejection thresholds (Mahalanobis distance)
odom0_pose_rejection_threshold: 5.0
odom0_twist_rejection_threshold: 3.0  # Tăng tolerance

# ==============================================================================
# SENSOR 1: IMU
# ==============================================================================
imu0: /robot_0/imu/data
imu0_config: [false, false, false,   # x, y, z position
              false, false, true,    # roll, pitch, yaw - CHỈ DÙNG YAW (quan trọng!)
              false, false, false,   # x_vel, y_vel, z_vel
              false, false, true,    # roll_vel, pitch_vel, yaw_vel - CHỈ DÙNG YAW VELOCITY
              true,  true,  false]   # x_acc, y_acc, z_acc - Dùng để estimate velocity
imu0_queue_size: 5  # Giảm từ 10 để tiết kiệm memory
imu0_remove_gravitational_acceleration: true
imu0_differential: false
imu0_relative: false

# IMU rejection thresholds - Giảm để tin IMU hơn
imu0_pose_rejection_threshold: 3.0  # TĂNG - tin yaw từ IMU
imu0_twist_rejection_threshold: 1.5  # TĂNG
imu0_linear_acceleration_rejection_threshold: 1.5  # TĂNG

# ==============================================================================
# PROCESS NOISE COVARIANCE (CRITICAL - prevents NaN and filters drift)
# Order: x, y, z, roll, pitch, yaw, vx, vy, vz, vroll, vpitch, vyaw, ax, ay, az
# TĂNG velocity noise để lọc drift khi đứng im
# ==============================================================================
process_noise_covariance: [0.01, 0,    0,    0,    0,    0,    0,     0,     0,    0,    0,    0,    0,    0,    0,
                           0,    0.01, 0,    0,    0,    0,    0,     0,     0,    0,    0,    0,    0,    0,    0,
                           0,    0,    0.06, 0,    0,    0,    0,     0,     0,    0,    0,    0,    0,    0,    0,
                           0,    0,    0,    0.03, 0,    0,    0,     0,     0,    0,    0,    0,    0,    0,    0,
                           0,    0,    0,    0,    0.03, 0,    0,     0,     0,    0,    0,    0,    0,    0,    0,
                           0,    0,    0,    0,    0,    0.02, 0,     0,     0,    0,    0,    0,    0,    0,    0,
                           0,    0,    0,    0,    0,    0,    0.3,   0,     0,    0,    0,    0,    0,    0,    0,
                           0,    0,    0,    0,    0,    0,    0,     0.3,   0,    0,    0,    0,    0,    0,    0,
                           0,    0,    0,    0,    0,    0,    0,     0,     0.04, 0,    0,    0,    0,    0,    0,
                           0,    0,    0,    0,    0,    0,    0,     0,     0,    0,    0.03, 0,    0,    0,    0,
                           0,    0,    0,    0,    0,    0,    0,     0,     0,    0,    0.03, 0,    0,    0,    0,
                           0,    0,    0,    0,    0,    0,    0,     0,     0,    0,    0,    0.15, 0,    0,    0,
                           0,    0,    0,    0,    0,    0,    0,     0,     0,    0,    0,    0,    0.03, 0,    0,
                           0,    0,    0,    0,    0,    0,    0,     0,     0,    0,    0,    0,    0,    0.03, 0,
                           0,    0,    0,    0,    0,    0,    0,     0,     0,    0,    0,    0,    0,    0,    0.015]

# ==============================================================================
# INITIAL ESTIMATE COVARIANCE (CRITICAL - prevents NaN at startup)
# Large values = fast convergence for measured variables
# Small values = slow convergence
# ==============================================================================
initial_estimate_covariance: [1e-9, 0,    0,    0,    0,    0,    0,    0,    0,    0,     0,     0,     0,    0,    0,
                              0,    1e-9, 0,    0,    0,    0,    0,    0,    0,    0,     0,     0,     0,    0,    0,
                              0,    0,    1e-9, 0,    0,    0,    0,    0,    0,    0,     0,     0,     0,    0,    0,
                              0,    0,    0,    1e-9, 0,    0,    0,    0,    0,    0,     0,     0,     0,    0,    0,
                              0,    0,    0,    0,    1e-9, 0,    0,    0,    0,    0,     0,     0,     0,    0,    0,
                              0,    0,    0,    0,    0,    1e-9, 0,    0,    0,    0,     0,     0,     0,    0,    0,
                              0,    0,    0,    0,    0,    0,    1e-9, 0,    0,    0,     0,     0,     0,    0,    0,
                              0,    0,    0,    0,    0,    0,    0,    1e-9, 0,    0,     0,     0,     0,    0,    0,
                              0,    0,    0,    0,    0,    0,    0,    0,    1e-9, 0,     0,     0,     0,    0,    0,
                              0,    0,    0,    0,    0,    0,    0,    0,    0,    1e-9,  0,     0,     0,    0,    0,
                              0,    0,    0,    0,    0,    0,    0,    0,    0,    0,     1e-9,  0,     0,    0,    0,
                              0,    0,    0,    0,    0,    0,    0,    0,    0,    0,     0,     1e-9,  0,    0,    0,
                              0,    0,    0,    0,    0,    0,    0,    0,    0,    0,     0,     0,     1e-9, 0,    0,
                              0,    0,    0,    0,    0,    0,    0,    0,    0,    0,     0,     0,     0,    1e-9, 0,
                              0,    0,    0,    0,    0,    0,    0,    0,    0,    0,     0,     0,     0,    0,    1e-9]

# ==============================================================================
# UKF PARAMETERS (CRITICAL for UKF)
# Controls sigma point spread
# ==============================================================================
alpha: 0.001
kappa: 0
beta: 2
