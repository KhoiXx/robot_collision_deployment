# ==============================================================================
# UKF Localization Configuration
# Fusion: Wheel Odometry + IMU
# ==============================================================================

frequency: 25  # OPTIMIZED: Giảm từ 30Hz để tiết kiệm CPU (~33% reduction)
sensor_timeout: 0.2  # Phù hợp với frequency 20Hz (increased from 0.15)
two_d_mode: true
print_diagnostics: false  # TẮT để giảm CPU load
publish_acceleration: true  # Không cần publish acceleration

# Frame configuration
odom_frame: robot_0/odom
base_link_frame: dummy_base_link
world_frame: robot_0/odom
publish_tf: true  # BẬT - UKF publish TF với IMU fusion cho yaw chính xác

# ==============================================================================
# SENSOR 0: Wheel Odometry
# ==============================================================================
odom0: /robot_0/odom
odom0_config: [true,  true,  false,   # x, y, z position - DÙNG position
               false, false, true,    # roll, pitch, yaw - BẬT YAW TỪ ENCODER! (CRITICAL FIX)
               true,  true,  false,   # x_vel, y_vel, z_vel - DÙNG velocity
               false, false, false,   # roll_vel, pitch_vel, yaw_vel - KHÔNG DÙNG
               false, false, false]   # x_acc, y_acc, z_acc
odom0_queue_size: 5  # Giảm từ 10 để tiết kiệm memory
odom0_differential: false  # TẮT differential - dùng position trực tiếp
odom0_relative: false

# Rejection thresholds (Mahalanobis distance) - TĂNG TRUST ENCODER YAW
odom0_pose_rejection_threshold: 2.5  # GIẢM từ 4.0 → 2.5 (tin encoder yaw hơn)
odom0_twist_rejection_threshold: 2.5  # GIẢM từ 3.0 → 2.5

# ==============================================================================
# SENSOR 1: IMU
# ==============================================================================
imu0: /robot_0/imu/data
imu0_config: [false, false, false,   # x, y, z position
              false, false, true,    # roll, pitch, yaw - CHỈ DÙNG YAW (quan trọng!)
              false, false, false,   # x_vel, y_vel, z_vel
              false, false, true,    # roll_vel, pitch_vel, yaw_vel - CHỈ DÙNG YAW VELOCITY
              true,  true,  false]   # x_acc, y_acc, z_acc - Dùng để estimate velocity
imu0_queue_size: 5  # Giảm từ 10 để tiết kiệm memory
imu0_remove_gravitational_acceleration: true
imu0_differential: false
imu0_relative: false

# IMU rejection thresholds - GIẢM TRUST IMU để cân bằng với encoder
imu0_pose_rejection_threshold: 5.0  # TĂNG từ 3.0 → 5.0 (giảm trust IMU yaw, ưu tiên encoder)
imu0_twist_rejection_threshold: 2.0  # TĂNG từ 1.0 → 2.0
imu0_linear_acceleration_rejection_threshold: 2.0  # TĂNG từ 1.5 → 2.0

# ==============================================================================
# PROCESS NOISE COVARIANCE (CRITICAL - prevents NaN and filters drift)
# Order: x, y, z, roll, pitch, yaw, vx, vy, vz, vroll, vpitch, vyaw, ax, ay, az
# TĂNG velocity noise để lọc drift khi đứng im
# ==============================================================================
process_noise_covariance: [0.001, 0,    0,    0,    0,    0,    0,     0,     0,    0,    0,    0,    0,    0,    0,
                           0,    0.001, 0,    0,    0,    0,    0,     0,     0,    0,    0,    0,    0,    0,    0,
                           0,    0,    0.06, 0,    0,    0,    0,     0,     0,    0,    0,    0,    0,    0,    0,
                           0,    0,    0,    0.03, 0,    0,    0,     0,     0,    0,    0,    0,    0,    0,    0,
                           0,    0,    0,    0,    0.03, 0,    0,     0,     0,    0,    0,    0,    0,    0,    0,
                           0,    0,    0,    0,    0,    0.03, 0,     0,     0,    0,    0,    0,    0,    0,    0,
                           0,    0,    0,    0,    0,    0,    0.005, 0,     0,    0,    0,    0,    0,    0,    0,
                           0,    0,    0,    0,    0,    0,    0,     0.005, 0,    0,    0,    0,    0,    0,    0,
                           0,    0,    0,    0,    0,    0,    0,     0,     0.04, 0,    0,    0,    0,    0,    0,
                           0,    0,    0,    0,    0,    0,    0,     0,     0,    0,    0.01, 0,    0,    0,    0,
                           0,    0,    0,    0,    0,    0,    0,     0,     0,    0,    0.01, 0,    0,    0,    0,
                           0,    0,    0,    0,    0,    0,    0,     0,     0,    0,    0,    0.02, 0,    0,    0,
                           0,    0,    0,    0,    0,    0,    0,     0,     0,    0,    0,    0,    0.01, 0,    0,
                           0,    0,    0,    0,    0,    0,    0,     0,     0,    0,    0,    0,    0,    0.01, 0,
                           0,    0,    0,    0,    0,    0,    0,     0,     0,    0,    0,    0,    0,    0,    0.015]

# ==============================================================================
# INITIAL ESTIMATE COVARIANCE (CRITICAL - prevents NaN at startup)
# Large values = fast convergence for measured variables
# Small values = slow convergence
# Tăng yaw covariance để cho phép fusion nhanh hơn
# ==============================================================================
initial_estimate_covariance: [0.5,  0,    0,    0,    0,    0,    0,    0,    0,    0,     0,     0,     0,    0,    0,
                              0,    0.5,  0,    0,    0,    0,    0,    0,    0,    0,     0,     0,     0,    0,    0,
                              0,    0,    1e-9, 0,    0,    0,    0,    0,    0,    0,     0,     0,     0,    0,    0,
                              0,    0,    0,    1e-9, 0,    0,    0,    0,    0,    0,     0,     0,     0,    0,    0,
                              0,    0,    0,    0,    1e-9, 0,    0,    0,    0,    0,     0,     0,     0,    0,    0,
                              0,    0,    0,    0,    0,    0.1,  0,    0,    0,    0,     0,     0,     0,    0,    0,
                              0,    0,    0,    0,    0,    0,    0.1,  0,    0,    0,     0,     0,     0,    0,    0,
                              0,    0,    0,    0,    0,    0,    0,    0.1,  0,    0,     0,     0,     0,    0,    0,
                              0,    0,    0,    0,    0,    0,    0,    0,    1e-9, 0,     0,     0,     0,    0,    0,
                              0,    0,    0,    0,    0,    0,    0,    0,    0,    1e-9,  0,     0,     0,    0,    0,
                              0,    0,    0,    0,    0,    0,    0,    0,    0,    0,     1e-9,  0,     0,    0,    0,
                              0,    0,    0,    0,    0,    0,    0,    0,    0,    0,     0,     1e-9,  0,    0,    0,
                              0,    0,    0,    0,    0,    0,    0,    0,    0,    0,     0,     0,     1e-9, 0,    0,
                              0,    0,    0,    0,    0,    0,    0,    0,    0,    0,     0,     0,     0,    1e-9, 0,
                              0,    0,    0,    0,    0,    0,    0,    0,    0,    0,     0,     0,     0,    0,    1e-9]

# ==============================================================================
# UKF PARAMETERS (CRITICAL for UKF)
# Controls sigma point spread
# ==============================================================================
alpha: 0.001
kappa: 0
beta: 2
