# AMCL Configuration for Real Robot Navigation
# Tuned for differential drive robot with LiDAR sensor
# Cross-checked with gmapping parameters from robot_mapping.launch
# Updated: 2025-11-23

# ==============================================================================
# ODOMETRY MODEL (differential drive)
# GIẢM noise để tin UKF filtered odometry hơn
# ==============================================================================
odom_model_type: diff
odom_alpha1: 0.05  # Rotation noise from rotation - GIẢM (tin UKF)
odom_alpha2: 0.05  # Rotation noise from translation - GIẢM
odom_alpha3: 0.05  # Translation noise from translation - GIẢM
odom_alpha4: 0.05  # Translation noise from rotation - GIẢM
odom_alpha5: 0.05  # Translation noise (diff-corrected model) - GIẢM

# ==============================================================================
# LASER MODEL
# Match với gmapping: maxRange=6.0, maxUrange=5.5
# ==============================================================================
laser_model_type: likelihood_field
laser_max_beams: 60           # Số tia LiDAR (LD19 có 720 điểm, 60 đủ dùng)
laser_z_hit: 0.95             # Trọng số đo đạc đúng
laser_z_rand: 0.05            # Trọng số đo đạc ngẫu nhiên
laser_sigma_hit: 0.075        # Match gmapping lsigma
laser_likelihood_max_dist: 5.0  # TĂNG từ 2.0 để match gmapping maxUrange

# ==============================================================================
# PARTICLE FILTER
# Reduced for faster computation on slow robot (0.4 m/s)
# ==============================================================================
min_particles: 50             # GIẢM để giảm CPU load
max_particles: 200            # GIẢM để tránh overload
kld_err: 0.05                 # KLD sampling error
kld_z: 0.99                   # KLD sampling confidence

# ==============================================================================
# UPDATE THRESHOLDS
# Reduced for more frequent updates
# ==============================================================================
update_min_d: 0.01            # Update mỗi 1cm - rất responsive
update_min_a: 0.01            # Update mỗi ~0.5 degrees - rất responsive
resample_interval: 2          # Resample mỗi 2 lần update (giảm CPU)

# ==============================================================================
# TRANSFORM
# ==============================================================================
transform_tolerance: 1.0      # Độ trễ TF cho phép (seconds) - tăng lên vì UKF 30Hz

# ==============================================================================
# INITIAL POSE (khi set trong RViz)
# ==============================================================================
initial_pose_x: 0.0
initial_pose_y: 0.0
initial_pose_a: 0.0
initial_cov_xx: 0.25          # Variance X (0.5m std dev)
initial_cov_yy: 0.25          # Variance Y (0.5m std dev)
initial_cov_aa: 0.068         # Variance yaw (~15 degrees)

# ==============================================================================
# RECOVERY (tắt để tránh random particles khi mất localization)
# ==============================================================================
recovery_alpha_slow: 0.0
recovery_alpha_fast: 0.0

# ==============================================================================
# TUNING NOTES
# ==============================================================================
# - Localization không ổn định → tăng min/max_particles
# - CPU cao → giảm laser_max_beams, max_particles
# - Localization chậm → giảm update_min_d, update_min_a
# - Không tin odom → tăng odom_alpha values
# - Map mismatch → kiểm tra laser_sigma_hit
