<launch>
  <!-- ============================================================================
       UKF NAVIGATION with AMCL VISUALIZATION
       ============================================================================
       Strategy:
       - Robot trusts 100% UKF for navigation (no blending)
       - AMCL runs for visualization ONLY (publish map->odom TF)
       - You can see robot on map in RViz and set goals
       - But robot control uses pure UKF (reliable, no jumps)

       Best of both worlds:
       ✅ Visualize robot on map (AMCL TF)
       ✅ Set goals using RViz 2D Nav Goal
       ✅ Robot navigation trusts 100% UKF (no AMCL influence)
       ✅ Never lose position or run backwards

       Usage:
         roslaunch robot_controller navigation_ukf_with_viz.launch
  -->

  <!-- Arguments -->
  <arg name="robot_namespace" default="/robot_0"/>
  <arg name="map_file" default="$(find robot_controller)/maps/cate_test_11.yaml"/>
  <arg name="open_rviz" default="true"/>

  <!-- ============================================================================
       MAP SERVER (For Visualization and AMCL)
       ============================================================================ -->

  <node pkg="map_server" type="map_server" name="map_server"
        args="$(arg map_file)" output="screen" />

  <!-- ============================================================================
       AMCL LOCALIZATION (For Visualization ONLY - not used for navigation)
       ============================================================================ -->

  <node pkg="amcl" type="amcl" name="amcl" output="screen">
    <!-- Load config with HIGH odom trust -->
    <rosparam file="$(find robot_controller)/config/amcl.yaml" command="load" />

    <!-- Topic remapping -->
    <remap from="scan" to="$(arg robot_namespace)/scan" />
    <remap from="initialpose" to="$(arg robot_namespace)/initialpose" />
    <remap from="amcl_pose" to="$(arg robot_namespace)/amcl_pose" />

    <!-- Frame IDs -->
    <param name="odom_frame_id" value="$(arg robot_namespace)/odom" />
    <param name="base_frame_id" value="dummy_base_link" />
    <param name="global_frame_id" value="map" />

    <!-- Publish TF for visualization -->
    <param name="tf_broadcast" value="true" />
  </node>

  <!-- ============================================================================
       RL MODEL (Pure UKF Navigation - AMCL ignored)
       ============================================================================ -->

  <node pkg="robot_controller" type="run_model_safe.py" name="model_controller_ukf_viz"
        ns="$(arg robot_namespace)" output="screen">
    <!-- CRITICAL: Pure UKF mode - AMCL is ONLY for visualization -->
    <param name="use_pure_ukf" value="true" />
  </node>

  <!-- ============================================================================
       RVIZ (Optional - for visualization and setting goals)
       ============================================================================ -->

  <node if="$(arg open_rviz)" pkg="rviz" type="rviz" name="rviz"
        args="-d $(find robot_controller)/rviz/navigation_ukf_viz.rviz" output="screen" />

  <!-- ============================================================================
       NOTES
       ============================================================================

       Navigation procedure:
       1. Start this launch file
       2. Open RViz and load map
       3. Set initial pose for AMCL (for visualization):
          - Use "2D Pose Estimate" button in RViz, OR
          - rostopic pub /robot_0/initialpose geometry_msgs/PoseWithCovarianceStamped "header:
              frame_id: 'map'
            pose:
              pose:
                position: {x: 0.0, y: 0.0, z: 0.0}
                orientation: {w: 1.0}
              covariance: [0.25, 0, 0, 0, 0, 0, 0, 0.25, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.068]"

       4. Wait for "[AMCL] Localized!" (you'll see robot on map)
       5. Set goal using RViz "2D Nav Goal" button, OR:
          rostopic pub /robot_0/move_base_simple/goal geometry_msgs/PoseStamped "header:
            frame_id: 'map'
          pose:
            position: {x: 1.0, y: 1.0, z: 0.0}
            orientation: {w: 1.0}"

       Emergency stop:
         rostopic pub /robot_0/emergency_stop std_msgs/Bool true

       Monitor:
       - /robot_0/amcl_pose: AMCL pose (visualization only)
       - /robot_0/odometry/filtered: UKF pose (100% used for navigation)
       - /robot_0/cmd_vel: Velocity commands (based on UKF)

       How it works:
       ✅ AMCL publishes TF map->odom (for RViz visualization)
       ✅ Robot_env uses use_pure_ukf=true → ignores AMCL pose
       ✅ Navigation uses 100% UKF (reliable, no jumps)
       ✅ You see robot on map and can set goals visually
       ✅ But AMCL failures don't affect navigation

       Expected performance:
       - Visualization: Robot appears on map in RViz
       - Navigation: Smooth, reliable (100% UKF)
       - CPU: ~15-20% (AMCL for viz only)
       - No "lost position" or "running backwards" issues
  -->

</launch>
