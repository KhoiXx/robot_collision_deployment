<launch>
  <!-- ============================================================================
       CARTOGRAPHER MAPPING MODE
       ============================================================================
       Thay thế gmapping - tạo map mới

       Usage:
         roslaunch robot_controller cartographer_mapping.launch

       Sau khi mapping xong:
         1. Ctrl+C để stop
         2. Map tự động save vào maps/ folder
         3. Dùng cartographer_localization.launch để navigate
  -->

  <!-- Arguments -->
  <arg name="robot_namespace" default="/robot_0"/>
  <arg name="configuration_basename" default="robot_2d.lua"/>
  <arg name="save_map_name" default="cartographer_map"/>

  <param name="use_sim_time" value="false"/>

  <!-- Load robot description (URDF) -->
  <param name="robot_description" command="cat $(find robot_description)/urdf/robot_description.urdf" />

  <!-- Robot State Publisher @ 10Hz -->
  <!-- <node pkg="robot_state_publisher" type="robot_state_publisher" name="robot_state_publisher" output="screen">
    <param name="publish_frequency" value="10.0"/>
  </node> -->

  <!-- Teleop keyboard -->
  <!-- <node pkg="teleop_twist_keyboard" type="teleop_twist_keyboard.py" name="teleop_twist_keyboard" output="screen">
    <remap from="cmd_vel" to="$(arg robot_namespace)/cmd_vel"/>
  </node> -->

  <!-- ============================================================================
       CARTOGRAPHER NODE - SLAM MODE
       ============================================================================ -->
  <node name="cartographer_node" pkg="cartographer_ros" type="cartographer_node"
        args="-configuration_directory $(find robot_controller)/config/cartographer
              -configuration_basename $(arg configuration_basename)"
        output="screen">

    <!-- Topic remapping -->
    <remap from="scan" to="$(arg robot_namespace)/scan" />
    <remap from="odom" to="$(arg robot_namespace)/odometry/filtered" />  <!-- Use UKF filtered odom -->
    <remap from="imu" to="$(arg robot_namespace)/imu/data" />
  </node>

  <!-- Cartographer Occupancy Grid Node (publish map for visualization) -->
  <node name="cartographer_occupancy_grid_node"
        pkg="cartographer_ros"
        type="cartographer_occupancy_grid_node"
        args="-resolution 0.05" />

  <!-- ============================================================================
       MAP SAVING (automatic on shutdown)
       ============================================================================ -->

  <!-- On shutdown, save map automatically -->
  <!-- DISABLED: Manual save recommended - use: rosservice call /write_state "{filename: '...'}" -->
  <!-- <node name="cartographer_map_saver" pkg="robot_controller" type="save_cartographer_map.sh"
        args="$(arg save_map_name)"
        required="false" /> -->

  <!-- ============================================================================
       NOTES
       ============================================================================

       Mapping procedure:
       1. Start this launch file
       2. Drive robot around using teleop_twist_keyboard (w/a/s/d)
       3. Watch /map topic in RViz
       4. When done, press Ctrl+C
       5. Map saved to: maps/cartographer_map.pbstream (Cartographer format)
                        maps/cartographer_map.pgm/.yaml (ROS format for compatibility)

       Tips:
       - Drive slowly (< 0.2 m/s) for better mapping
       - Close loops (return to start) for loop closure
       - Cover all areas you want in map
       - Avoid jerky movements

       Monitor CPU on Jetson:
         python3 ~/thesis/deployment/src/robot_controller/src/diagnose_jetson.py

       Expected performance:
       - Jetson CPU: 20-30%
       - Master CPU: 10-20%
       - Memory: ~500-700 MB
  -->

</launch>
